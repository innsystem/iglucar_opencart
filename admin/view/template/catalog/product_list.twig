{{ header }}{{ column_left }}
<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <div class="pull-right">
        <button type="button" data-toggle="tooltip" title="{{ button_filter }}" onclick="$('#filter-product').toggleClass('hidden-sm hidden-xs');" class="btn btn-default hidden-md hidden-lg"><i class="fa fa-filter"></i></button>
        <a href="{{ add }}" data-toggle="tooltip" title="{{ button_add }}" class="btn btn-primary"><i class="fa fa-plus"></i></a>
        <button type="submit" form="form-product" formaction="{{ copy }}" data-toggle="tooltip" title="{{ button_copy }}" class="btn btn-default"><i class="fa fa-copy"></i></button>
        <button type="button" form="form-product" formaction="{{ delete }}" data-toggle="tooltip" title="{{ button_delete }}" class="btn btn-danger" onclick="confirm('{{ text_confirm }}') ? $('#form-product').submit() : false;"><i class="fa fa-trash-o"></i></button>
      </div>
      <h1>{{ heading_title }}</h1>
      <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
        <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
      </ul>
    </div>
  </div>
  <div class="container-fluid">{% if error_warning %}
    <div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}
      <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
    {% endif %}
    {% if success %}
    <div class="alert alert-success alert-dismissible"><i class="fa fa-check-circle"></i> {{ success }}
      <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
    {% endif %}
    <div class="row">
      <div id="filter-product" class="col-md-3 col-md-push-9 col-sm-12 hidden-sm hidden-xs">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title"><i class="fa fa-filter"></i> {{ text_filter }}</h3>
          </div>
          <div class="panel-body">
            <div class="form-group">
              <label class="control-label" for="input-name">{{ entry_name }}</label>
              <input type="text" name="filter_name" value="{{ filter_name }}" placeholder="{{ entry_name }}" id="input-name" class="form-control" />
            </div>
            <div class="form-group">
              <label class="control-label" for="input-model">{{ entry_model }}</label>
              <input type="text" name="filter_model" value="{{ filter_model }}" placeholder="{{ entry_model }}" id="input-model" class="form-control" />
            </div>
            <div class="form-group">
              <label class="control-label" for="input-price">{{ entry_price }}</label>
              <input type="text" name="filter_price" value="{{ filter_price }}" placeholder="{{ entry_price }}" id="input-price" class="form-control" />
            </div>
            <div class="form-group">
              <label class="control-label" for="input-quantity">{{ entry_quantity }}</label>
              <input type="text" name="filter_quantity" value="{{ filter_quantity }}" placeholder="{{ entry_quantity }}" id="input-quantity" class="form-control" />
            </div>
            <div class="form-group">
              <label class="control-label" for="input-status">{{ entry_status }}</label>
              <select name="filter_status" id="input-status" class="form-control">
                <option value=""></option>
                {% if filter_status == '1' %}
                <option value="1" selected="selected">{{ text_enabled }}</option>
                {% else %}
                <option value="1">{{ text_enabled }}</option>
                {% endif %}
                {% if filter_status == '0' %}
                <option value="0" selected="selected">{{ text_disabled }}</option>
                {% else %}
                <option value="0">{{ text_disabled }}</option>
                {% endif %}
              </select>
            </div>
            <div class="form-group text-right">
              <button type="button" id="button-filter" class="btn btn-default"><i class="fa fa-filter"></i> {{ button_filter }}</button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-9 col-md-pull-3 col-sm-12">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title"><i class="fa fa-list"></i> {{ text_list }}</h3>
          </div>
          <div class="panel-body">
            <form action="{{ delete }}" method="post" enctype="multipart/form-data" id="form-product">
              <input type="hidden" name="user_token" value="{{ user_token }}">
              <div class="table-responsive">
                <table class="table table-bordered table-hover">
                  <thead>
                    <tr>
                      <td style="width: 1px;" class="text-center"><input type="checkbox" onclick="$('input[name*=\'selected\']').prop('checked', this.checked);" /></td>
                      <td class="text-center">{{ column_image }}</td>
                      <td class="text-left">{% if sort == 'pd.name' %} <a href="{{ sort_name }}" class="{{ order|lower }}">{{ column_name }}</a> {% else %} <a href="{{ sort_name }}">{{ column_name }}</a> {% endif %}</td>
                      <td class="text-left">{% if sort == 'p.model' %} <a href="{{ sort_model }}" class="{{ order|lower }}">{{ column_model }}</a> {% else %} <a href="{{ sort_model }}">{{ column_model }}</a> {% endif %}</td>
                      <td class="text-right">{% if sort == 'p.price' %} <a href="{{ sort_price }}" class="{{ order|lower }}">{{ column_price }}</a> {% else %} <a href="{{ sort_price }}">{{ column_price }}</a> {% endif %}</td>
                      <td class="text-right">{% if sort == 'p.quantity' %} <a href="{{ sort_quantity }}" class="{{ order|lower }}">{{ column_quantity }}</a> {% else %} <a href="{{ sort_quantity }}">{{ column_quantity }}</a> {% endif %}</td>
                      <td class="text-left">{% if sort == 'p.status' %} <a href="{{ sort_status }}" class="{{ order|lower }}">{{ column_status }}</a> {% else %} <a href="{{ sort_status }}">{{ column_status }}</a> {% endif %}</td>
                      <td class="text-right">{{ column_action }}</td>
                    </tr>
                  </thead>
                  <tbody>
                  
                  {% if products %}
                  {% for product in products %}
                  <tr>
                    <td class="text-center">{% if product.product_id in selected %}
                      <input type="checkbox" name="selected[]" value="{{ product.product_id }}" checked="checked" />
                      {% else %}
                      <input type="checkbox" name="selected[]" value="{{ product.product_id }}" />
                      {% endif %}</td>
                    <td class="text-center">
                      <div class="quick-edit-image" data-product-id="{{ product.product_id }}" data-toggle="tooltip" title="Clique para alterar a imagem">
                        {% if product.image %} 
                          <img src="{{ product.image }}" alt="{{ product.name }}" class="img-thumbnail" /> 
                        {% else %} 
                          <span class="img-thumbnail list"><i class="fa fa-camera fa-2x"></i></span> 
                        {% endif %}
                      </div>
                      <div class="text-center" style="margin-top: 5px;">
                        <button type="button" class="btn btn-info btn-xs update-image-btn" 
                                data-product-id="{{ product.product_id }}" 
                                data-product-name="{{ product.name }}"
                                data-toggle="tooltip" title="Atualizar Imagem">
                          <i class="fa fa-download"></i> Atualizar
                        </button>
                        <a href="#" class="open-google-images" data-product-name="{{ product.name }}" style="display:none"></a>
                      </div>
                    </td>
                    <td class="text-left">
                      <div class="quick-edit-field editable" data-field="name" data-product-id="{{ product.product_id }}">
                        <span class="field-value">{{ product.name }}</span>
                        <i class="fa fa-pencil quick-edit-icon" data-toggle="tooltip" title="Editar nome"></i>
                      </div>
                    </td>
                    <td class="text-left">
                      <div class="quick-edit-field editable" data-field="model" data-product-id="{{ product.product_id }}">
                        <span class="field-value">{{ product.model }}</span>
                        <i class="fa fa-pencil quick-edit-icon" data-toggle="tooltip" title="Editar modelo"></i>
                      </div>
                    </td>
                    <td class="text-right">
                      {% if product.special %}
                        <span style="text-decoration: line-through;">{{ product.price }}</span><br/>
                        <div class="text-danger quick-edit-field editable" data-field="price" data-product-id="{{ product.product_id }}">
                          <span class="field-value">{{ product.special }}</span>
                          <i class="fa fa-pencil quick-edit-icon" data-toggle="tooltip" title="Editar preço especial"></i>
                        </div>
                      {% else %}
                        <div class="quick-edit-field editable" data-field="price" data-product-id="{{ product.product_id }}">
                          <span class="field-value">{{ product.price }}</span>
                          <i class="fa fa-pencil quick-edit-icon" data-toggle="tooltip" title="Editar preço"></i>
                        </div>
                      {% endif %}
                    </td>
                    <td class="text-right">
                      <div class="quick-edit-field editable" data-field="quantity" data-product-id="{{ product.product_id }}">
                        {% if product.quantity <= 0 %} 
                          <span class="field-value label label-warning">{{ product.quantity }}</span>
                        {% elseif product.quantity <= 5 %} 
                          <span class="field-value label label-danger">{{ product.quantity }}</span>
                        {% else %} 
                          <span class="field-value label label-success">{{ product.quantity }}</span>
                        {% endif %}
                        <i class="fa fa-pencil quick-edit-icon" data-toggle="tooltip" title="Editar quantidade"></i>
                      </div>
                    </td>
                    <td class="text-left">
                      <div class="status-switch">
                        <input type="checkbox" 
                               id="status-switch-{{ product.product_id }}" 
                               class="toggle-product-status" 
                               data-product-id="{{ product.product_id }}" 
                               data-status="{{ product.status }}"
                               {% if product.status %}checked{% endif %}>
                        <label for="status-switch-{{ product.product_id }}" 
                               class="switch-label">
                          <span class="switch-slider"></span>
                        </label>
                      </div>
                    </td>
                    <td class="text-right"><a href="{{ product.edit }}" data-toggle="tooltip" title="{{ button_edit }}" class="btn btn-primary"><i class="fa fa-pencil"></i></a></td>
                  </tr>
                  {% endfor %}
                  {% else %}
                  <tr>
                    <td class="text-center" colspan="8">{{ text_no_results }}</td>
                  </tr>
                  {% endif %}
                    </tbody>
                  
                </table>
              </div>
            </form>
            <div class="row">
              <div class="col-sm-6 text-left">{{ pagination }}</div>
              <div class="col-sm-6 text-right">{{ results }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Atualizar Imagem -->
  <div class="modal fade" id="updateImageModal" tabindex="-1" role="dialog" aria-labelledby="updateImageModalLabel" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg" role="document" style="width: 90%; max-width: 600px;">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="updateImageModalLabel">Atualizar Imagem do Produto</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="imageUrlInput">URL da Imagem:</label>
            <textarea id="imageUrlInput" 
                     class="form-control" 
                     rows="3" 
                     placeholder="Cole aqui o link da imagem (http://...)"></textarea>
            
          </div>
          <div class="form-group">
            <button type="button" class="btn btn-success btn-block" id="downloadImageBtn">
              <i class="fa fa-download"></i> Baixar e Atualizar Imagem
            </button>
          </div>
          <div class="form-group">
            <div id="imageUpdateProgress" style="display: none;">
              <div class="progress">
                <div class="progress-bar progress-bar-striped active" 
                     role="progressbar" 
                     style="width: 100%">
                  Processando...
                </div>
              </div>
            </div>
            <div id="imageUpdateResult" style="display: none;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Incluir CSS e JavaScript do Quick Edit -->
  <link rel="stylesheet" type="text/css" href="view/stylesheet/product_quick_edit.css" />
  <script type="text/javascript" src="view/javascript/product_quick_edit.js"></script>

  <script type="text/javascript"><!--
$('#button-filter').on('click', function() {
	var url = '';

	var filter_name = $('input[name=\'filter_name\']').val();

	if (filter_name) {
		url += '&filter_name=' + encodeURIComponent(filter_name);
	}

	var filter_model = $('input[name=\'filter_model\']').val();

	if (filter_model) {
		url += '&filter_model=' + encodeURIComponent(filter_model);
	}

	var filter_price = $('input[name=\'filter_price\']').val();

	if (filter_price) {
		url += '&filter_price=' + encodeURIComponent(filter_price);
	}

	var filter_quantity = $('input[name=\'filter_quantity\']').val();

	if (filter_quantity) {
		url += '&filter_quantity=' + encodeURIComponent(filter_quantity);
	}

	var filter_status = $('select[name=\'filter_status\']').val();

	if (filter_status !== '') {
		url += '&filter_status=' + encodeURIComponent(filter_status);
	}

	location = 'index.php?route=catalog/product&user_token={{ user_token }}' + url;
});

// IE and Edge fix!
$('button[form=\'form-product\']').on('click', function(e) {
	$('#form-product').attr('action', $(this).attr('formaction'));
});
  
$('input[name=\'filter_name\']').autocomplete({
	'source': function(request, response) {
		$.ajax({
			url: 'index.php?route=catalog/product/autocomplete&user_token={{ user_token }}&filter_name=' +  encodeURIComponent(request),
			dataType: 'json',
			success: function(json) {
				response($.map(json, function(item) {
					return {
						label: item['name'],
						value: item['product_id']
					}
				}));
			}
		});
	},
	'select': function(item) {
		$('input[name=\'filter_name\']').val(item['label']);
	}
});

$('input[name=\'filter_model\']').autocomplete({
	'source': function(request, response) {
		$.ajax({
			url: 'index.php?route=catalog/product/autocomplete&user_token={{ user_token }}&filter_model=' +  encodeURIComponent(request),
			dataType: 'json',
			success: function(json) {
				response($.map(json, function(item) {
					return {
						label: item['model'],
						value: item['product_id']
					}
				}));
			}
		});
	},
	'select': function(item) {
		$('input[name=\'filter_model\']').val(item['label']);
	}
});

// Configurações globais para o Quick Edit
window.quickEditDebug = true; // Ativar debug em desenvolvimento
window.user_token = '{{ user_token }}'; // Token do usuário

// Debug: verificar se elementos foram carregados
// console.log('Template carregado com Quick Edit');
// console.log('User token:', '{{ user_token }}');
// console.log('Produtos na página:', {{ products|length }});

// Inicializar tooltips do Bootstrap
$(function () {
  $('[data-toggle="tooltip"]').tooltip();
  
  // Debug: verificar se campos quick-edit foram criados
  // console.log('Campos editáveis encontrados:', $('.quick-edit-field').length);
  // console.log('Imagens editáveis encontradas:', $('.quick-edit-image').length);
  // console.log('Botões de status encontrados:', $('.quick-edit-status').length);
});

// Script para toggle de status dos produtos
$(document).ready(function() {
    $('.toggle-product-status').change(function() {
        var checkbox = $(this);
        var productId = checkbox.data('product-id');
        var currentStatus = checkbox.data('status');
        var newStatus = checkbox.is(':checked') ? 1 : 0;
        var statusSwitch = checkbox.closest('.status-switch');

        // Adicionar estado de loading
        statusSwitch.addClass('loading');
        checkbox.prop('disabled', true);

        $.ajax({
            url: 'index.php?route=catalog/product/toggleStatus&user_token={{ user_token }}',
            type: 'POST',
            data: { product_id: productId, status: newStatus },
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    // Atualiza o data-status
                    checkbox.data('status', newStatus);
                    
                    // Feedback visual de sucesso
                    statusSwitch.removeClass('loading');
                    statusSwitch.addClass('success');
                    setTimeout(function() {
                        statusSwitch.removeClass('success');
                    }, 1000);
                } else {
                    // Reverte o checkbox em caso de erro
                    checkbox.prop('checked', currentStatus == 1);
                    statusSwitch.removeClass('loading');
                    alert('Erro ao atualizar o status: ' + (response.error || 'Erro desconhecido'));
                }
            },
            error: function(xhr, status, error) {
                // Reverte o checkbox em caso de erro
                checkbox.prop('checked', currentStatus == 1);
                statusSwitch.removeClass('loading');
                alert('Erro de comunicação com o servidor: ' + error);
            },
            complete: function() {
                // Reabilitar o checkbox
                checkbox.prop('disabled', false);
            }
        });
    });
});

// JavaScript para Atualização de Imagens
$(document).ready(function() {
    var currentProductId = null;
    var currentProductName = null;
    var googleImagesUrl = '';

    // Abrir modal ao clicar no botão de atualizar imagem
    $('.update-image-btn').on('click', function() {
        currentProductId = $(this).data('product-id');
        currentProductName = $(this).data('product-name');
        
        // Limpar campos
        $('#imageUrlInput').val('');
        $('#imageUpdateResult').hide();
        $('#imageUpdateProgress').hide();
        
        // Montar URL do Google Images
        var searchQuery = encodeURIComponent(currentProductName);
        googleImagesUrl = 'https://www.google.com/search?tbm=isch&q=' + searchQuery + '&udm=2#vhid=nre_47U013hCGM&vssid=mosaic';
        
        // Atualizar título da modal
        $('#updateImageModalLabel').text('Atualizar Imagem: ' + currentProductName);
        
        // Abrir modal
        $('#updateImageModal').modal('show');
        if (googleImagesUrl) {
            window.open(googleImagesUrl, '_blank');
        }
    });

    // Processar download da imagem
    $('#downloadImageBtn').on('click', function() {
        var imageUrl = $('#imageUrlInput').val().trim();
        
        if (!imageUrl) {
            alert('Por favor, cole o URL da imagem.');
            return;
        }
        
        if (!currentProductId) {
            alert('Erro: Produto não identificado.');
            return;
        }

        // Mostrar progresso
        $('#imageUpdateProgress').show();
        $('#imageUpdateResult').hide();
        $('#downloadImageBtn').prop('disabled', true);

        // Fazer requisição AJAX
        $.ajax({
            url: 'index.php?route=catalog/product/downloadImage&user_token={{ user_token }}',
            type: 'POST',
            data: {
                product_id: currentProductId,
                product_name: currentProductName,
                image_url: imageUrl,
                user_token: '{{ user_token }}'
            },
            dataType: 'json',
            success: function(response) {
                $('#imageUpdateProgress').hide();
                $('#downloadImageBtn').prop('disabled', false);
                
                if (response.success) {
                    $('#imageUpdateResult').html(
                        '<div class="alert alert-success">' +
                        '<i class="fa fa-check-circle"></i> ' + response.message +
                        '</div>'
                    ).show();
                    
                    // Atualizar a imagem na listagem
                    if (response.image_url) {
                        var imgElement = $('[data-product-id="' + currentProductId + '"] img');
                        if (imgElement.length) {
                            imgElement.attr('src', response.image_url + '?t=' + new Date().getTime());
                        }
                    }
                    
                    // Fechar modal após 2 segundos
                    setTimeout(function() {
                        $('#updateImageModal').modal('hide');
                    }, 200);
                    
                } else {
                    $('#imageUpdateResult').html(
                        '<div class="alert alert-danger">' +
                        '<i class="fa fa-exclamation-circle"></i> ' + (response.error || 'Erro desconhecido') +
                        '</div>'
                    ).show();
                }
            },
            error: function(xhr, status, error) {
                $('#imageUpdateProgress').hide();
                $('#downloadImageBtn').prop('disabled', false);
                
                $('#imageUpdateResult').html(
                    '<div class="alert alert-danger">' +
                    '<i class="fa fa-exclamation-circle"></i> Erro de comunicação: ' + error +
                    '</div>'
                ).show();
            }
        });
    });

    // Limpar variáveis quando modal for fechada
    $('#updateImageModal').on('hidden.bs.modal', function() {
        currentProductId = null;
        currentProductName = null;
        googleImagesUrl = '';
    });
});

//--></script></div>
{{ footer }} 