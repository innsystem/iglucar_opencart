<div class="modal fade" id="modal-order-attachments" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">{{ heading_title }} - Pedido #{{ order_id }}</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Upload Area -->
        <div class="upload-section mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">{{ button_upload }}</h5>
            </div>
            <div class="card-body">
              <form id="form-upload" enctype="multipart/form-data">
                <input type="hidden" name="order_id" value="{{ order_id }}">
                <div class="form-group">
                  <div class="upload-area" id="upload-area">
                    <div class="upload-content">
                      <i class="fa fa-cloud-upload fa-3x text-muted mb-3"></i>
                      <p class="text-muted">{{ text_drag_drop }}</p>
                      <input type="file" id="file-input" name="files[]" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif" style="display: none;">
                      <button type="button" class="btn btn-primary" onclick="document.getElementById('file-input').click();">
                        <i class="fa fa-folder-open"></i> Selecionar Arquivos
                      </button>
                    </div>
                  </div>
                </div>
                <div class="upload-info">
                  <small class="text-muted">
                    {{ text_max_files }}<br>
                    {{ text_allowed_types }}<br>
                    {{ text_max_size }}
                  </small>
                </div>
                <div id="file-list" class="mt-3"></div>
                <div class="mt-3">
                  <button type="submit" class="btn btn-success" id="btn-upload" disabled>
                    <i class="fa fa-upload"></i> {{ button_upload }}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <hr>

        <!-- Existing Attachments -->
        <div class="attachments-section">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Anexos Existentes</h5>
            </div>
            <div class="card-body">
              <div id="attachments-list">
                {% if attachments %}
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Nome do Arquivo</th>
                          <th>Data de Upload</th>
                          <th>Ações</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for attachment in attachments %}
                        <tr data-attachment-id="{{ attachment.order_attachment_id }}">
                          <td>
                            <i class="fa fa-file-o"></i> {{ attachment.filename }}
                          </td>
                          <td>{{ attachment.date_added|date('d/m/Y H:i') }}</td>
                          <td>
                            <a href="{{ url_link }}sale/order_attachment/view&user_token={{ user_token }}&order_attachment_id={{ attachment.order_attachment_id }}" 
                               class="btn btn-sm btn-info" target="_blank">
                              <i class="fa fa-eye"></i> {{ button_view }}
                            </a>
                            <a href="{{ url_link }}sale/order_attachment/download&user_token={{ user_token }}&order_attachment_id={{ attachment.order_attachment_id }}" 
                               class="btn btn-sm btn-info" target="_blank">
                              <i class="fa fa-download"></i> {{ button_download }}
                            </a>
                            <button type="button" class="btn btn-sm btn-danger" 
                                    onclick="deleteAttachment({{ attachment.order_attachment_id }})">
                              <i class="fa fa-trash"></i> {{ button_delete }}
                            </button>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <div class="alert alert-info">
                    <i class="fa fa-info-circle"></i> {{ text_no_attachments }}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ button_close }}</button>
      </div>
    </div>
  </div>
</div>

<style>
.upload-area {
  border: 2px dashed #ddd;
  border-radius: 10px;
  padding: 40px;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
}

.upload-area:hover,
.upload-area.dragover {
  border-color: #007bff;
  background-color: #f8f9fa;
}

.upload-area.dragover {
  border-color: #28a745;
  background-color: #d4edda;
}

.file-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 5px;
  margin-bottom: 5px;
  background-color: #f8f9fa;
}

.file-item .file-info {
  display: flex;
  align-items: center;
}

.file-item .file-info i {
  margin-right: 10px;
  color: #6c757d;
}

.progress {
  height: 20px;
  margin-top: 10px;
}
</style>

<script>
$(document).ready(function() {
  const uploadArea = document.getElementById('upload-area');
  const fileInput = document.getElementById('file-input');
  const fileList = document.getElementById('file-list');
  const uploadBtn = document.getElementById('btn-upload');
  let selectedFiles = [];

  // Drag and drop functionality
  uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });

  uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
  });

  uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = Array.from(e.dataTransfer.files);
    handleFiles(files);
  });

  // File input change
  fileInput.addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    handleFiles(files);
  });

  function handleFiles(files) {
    selectedFiles = files;
    displayFiles();
    uploadBtn.disabled = files.length === 0;
  }

  function displayFiles() {
    fileList.innerHTML = '';
    selectedFiles.forEach((file, index) => {
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item';
      fileItem.innerHTML = `
        <div class="file-info">
          <i class="fa fa-file-o"></i>
          <span>${file.name} (${formatFileSize(file.size)})</span>
        </div>
        <button type="button" class="btn btn-sm btn-danger" onclick="removeFile(${index})">
          <i class="fa fa-times"></i>
        </button>
      `;
      fileList.appendChild(fileItem);
    });
  }

  window.removeFile = function(index) {
    selectedFiles.splice(index, 1);
    displayFiles();
    uploadBtn.disabled = selectedFiles.length === 0;
  };

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // Form submission
  $('#form-upload').on('submit', function(e) {
    e.preventDefault();
    
    if (selectedFiles.length === 0) {
      alert('{{ error_no_files }}');
      return;
    }

    const formData = new FormData();
    formData.append('order_id', $('#form-upload input[name="order_id"]').val());
    
    selectedFiles.forEach(file => {
      formData.append('files[]', file);
    });

    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Enviando...';

    $.ajax({
      url: 'index.php?route=sale/order_attachment/upload&user_token={{ user_token }}',
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      dataType: 'json',
      success: function(json) {
        if (json.error) {
          alert(json.error);
        } else if (json.success) {
          alert(json.success);
          selectedFiles = [];
          displayFiles();
          loadAttachments();
        }
      },
      error: function() {
        alert('Erro ao enviar arquivos!');
      },
      complete: function() {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fa fa-upload"></i> {{ button_upload }}';
      }
    });
  });

  function loadAttachments() {
    $.ajax({
      url: 'index.php?route=sale/order_attachment/getAttachments&user_token={{ user_token }}&order_id={{ order_id }}',
      type: 'GET',
      dataType: 'json',
      success: function(json) {
        if (json.attachments) {
          updateAttachmentsList(json.attachments);
        }
      }
    });
  }

  function updateAttachmentsList(attachments) {
    let html = '';
    if (attachments.length > 0) {
      html = `
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Nome do Arquivo</th>
                <th>Data de Upload</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      attachments.forEach(attachment => {
        html += `
          <tr data-attachment-id="${attachment.order_attachment_id}">
            <td><i class="fa fa-file-o"></i> ${attachment.filename}</td>
            <td>${new Date(attachment.date_added).toLocaleDateString('pt-BR')}</td>
            <td>
              <a href="${attachment.download_url}" class="btn btn-sm btn-info" target="_blank">
                <i class="fa fa-download"></i> {{ button_download }}
              </a>
              <button type="button" class="btn btn-sm btn-danger" onclick="deleteAttachment(${attachment.order_attachment_id})">
                <i class="fa fa-trash"></i> {{ button_delete }}
              </button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table></div>';
    } else {
      html = '<div class="alert alert-info"><i class="fa fa-info-circle"></i> {{ text_no_attachments }}</div>';
    }
    
    $('#attachments-list').html(html);
  }
});

function deleteAttachment(attachmentId) {
  if (confirm('{{ text_confirm_delete }}')) {
    $.ajax({
      url: 'index.php?route=sale/order_attachment/deleteAttachment&user_token={{ user_token }}',
      type: 'POST',
      data: { order_attachment_id: attachmentId },
      dataType: 'json',
      success: function(json) {
        if (json.error) {
          alert(json.error);
        } else if (json.success) {
          alert(json.success);
          $('tr[data-attachment-id="' + attachmentId + '"]').remove();
        }
      },
      error: function() {
        alert('Erro ao excluir anexo!');
      }
    });
  }
}
</script>
